HanulWiki.ArticleModel=OBJECT({preset:function(){"use strict";return HanulWiki.MODEL},params:function(){"use strict";var e={id:{notEmpty:!0,size:{max:255}},content:{notEmpty:!0,size:{max:1e5}},keywords:{notEmpty:!0,array:!0},viewCount:{notEmpty:!0,integer:!0},backLinks:{notEmpty:!0,array:!0}};return{name:"Article",isNotUsingObjectId:!0,initData:{viewCount:0,keywords:[],backLinks:[]},methodConfig:{create:{valid:VALID(e),role:"USER"},update:{valid:VALID(e),role:"USER"},remove:{role:"USER"}}}}}),HanulWiki.BlockTagModel=OBJECT({preset:function(){"use strict";return HanulWiki.MODEL},params:function(){"use strict";var e={id:{notEmpty:!0,size:{max:255}}};return{name:"BlockTag",isNotUsingObjectId:!0,methodConfig:{create:{valid:VALID(e),role:"ADMIN"},update:{valid:VALID(e),role:"ADMIN"},remove:{role:"ADMIN"}}}}}),HanulWiki.TalkModel=OBJECT({preset:function(){"use strict";return HanulWiki.MODEL},params:function(){"use strict";var e={content:{notEmpty:!0,size:{max:3e3}},keywords:{notEmpty:!0,array:!0}};return{name:"Talk",initData:{keywords:[]},methodConfig:{create:{valid:VALID(e),role:"USER"},update:!1,remove:!1}}}});HanulWiki.MAIN=METHOD({run:function(){"use strict";var i;1===CPU_CLUSTERING.getWorkerId()&&(i=SHARED_DB("idDB"),INTERVAL(1,RAR(function(){HanulWiki.ArticleModel.find({isFindAll:!0},function(n){var o=[];EACH(n,function(i){var n=0;EACH(o,function(o,e){return o.length<i.id.length?!1:void(n=e+1)}),o.splice(n,0,i.id)}),i.save({id:"ids",data:{ids:o}}),EACH(n,function(i){var n=i.content.trim().replace(/ /g,"").toLowerCase(),e=[];EACH(o,function(o,t){var a;i.id!==o&&(a=n.replace(new RegExp(o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),""),a.length<n.length&&e.push(o),n=a)}),CHECK_ARE_SAME([i.keywords,e])!==!0&&(HanulWiki.ArticleModel.update({id:i.id,keywords:e}),EACH(e,function(n){HanulWiki.ArticleModel.updateNoHistory({id:n,$addToSet:{backLinks:i.id}})}))})})})))}}),OVERRIDE(HanulWiki.ArticleModel,function(i){"use strict";HanulWiki.ArticleModel=OBJECT({preset:function(){return i},init:function(i,n,o){var e=SHARED_DB("idDB"),t=HanulWiki.DB("Article__HISTORY"),a=HanulWiki.SHARED_STORE("banStore");i.on("create",{before:function(i,o,t,r){var u,d;return a.get(r.ip)===!0?t({validErrors:{ban:!0}}):(u=i.content.trim().replace(/ /g,"").toLowerCase(),d=e.get("ids").ids,i.keywords=[],i.ip=r.ip,EACH(d,function(n,o){var e=u.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"");e.length<u.length&&i.keywords.push(n),u=e}),GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(i.id)},function(e){HanulWiki.BlockTagModel.get(e,{notExists:function(){i.id=e,n.get(i.id,{notExists:o,success:function(){t({validErrors:{id:{type:"exists"}}})}})},success:function(){t({validErrors:{id:{type:"blocked"}}})}})})),!1},after:function(i){var o=e.get("ids").ids,t=0;EACH(o,function(n,o){return n.length<i.id.length?!1:void(t=o+1)}),e.update({id:"ids",data:{$push:{ids:{$each:[i.id],$position:t}}}}),EACH(i.keywords,function(o){n.updateNoHistory({id:o,$addToSet:{backLinks:i.id}})})}}),i.on("update",{before:function(i,n,o,t){var r,u;if(void 0!==t){if(a.get(t.ip)===!0)return o({validErrors:{ban:!0}}),!1;void 0!==i.content&&HanulWiki.BlockTagModel.get(i.id,{notExists:function(){r=i.content.trim().replace(/ /g,"").toLowerCase(),u=e.get("ids").ids,i.keywords=[],i.ip=t.ip,EACH(u,function(n,o){var e;n!==i.id&&(e=r.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),""),e.length<r.length&&i.keywords.push(n),r=e)})},success:function(){o({validErrors:{id:{type:"blocked"}}})}})}},after:function(i,o){i.content!==o.content&&(EACH(i.keywords,function(o){n.updateNoHistory({id:o,$addToSet:{backLinks:i.id}})}),HanulWiki.BROADCAST({roomName:"Article",methodName:"recentUpdate",data:i}))}}),i.on("remove",{before:function(i,n,o,e){return a.get(e.ip)===!0||CONFIG.HanulWiki.isCannotRemove===!0&&CHECK_IS_IN({array:e.roles,value:"ADMIN"})!==!0?(o({isNotAuthed:!0}),!1):void 0},after:function(i){e.get("ids").ids;e.update({id:"ids",data:{$pull:{ids:i.id}}}),EACH(i.keywords,function(o){n.updateNoHistory({id:o,$pull:{backLinks:i.id}})})}}),HanulWiki.ROOM(n.getName(),function(i,o){o("view",function(i,o){void 0!==i&&n.updateNoRecord({id:i,$inc:{viewCount:1}},{notExists:o,success:o})}),o("findHistory",function(i,n){void 0!==i&&t.find({filter:{docId:i.id},start:void 0===i.page?0:10*(i.page-1),count:10,sort:{time:-1}},n)}),o("searchIds",function(i,o){void 0!==i&&n.find({filter:{id:{$regex:i.trim().replace(/ /g,"").toLowerCase()}},sort:{viewCount:-1},count:20},function(i){var n=[];EACH(i,function(i){n.push(i.id)}),o(n)})})})}})}),OVERRIDE(HanulWiki.TalkModel,function(i){"use strict";HanulWiki.TalkModel=OBJECT({preset:function(){return i},init:function(i,n,o){var e=SHARED_DB("idDB"),t=HanulWiki.SHARED_STORE("banStore");i.on("create",{before:function(i,n,o,a){var r,u;return t.get(a.ip)===!0?(o({validErrors:{ban:!0}}),!1):(r=i.content.trim().replace(/ /g,"").toLowerCase(),u=e.get("ids").ids,i.keywords=[],i.ip=a.ip,EACH(u,function(n,o){var e=r.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"");e.length<r.length&&i.keywords.push(n),r=e}),void 0)}})}})}),HanulWiki.AuthRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("authRoom",function(i,n,o){n("auth",function(n,o){var e=void 0!==CONFIG.HanulWiki&&CONFIG.HanulWiki.isPublic===!0||void 0!==NODE_CONFIG.HanulWiki&&void 0!==n&&(n===NODE_CONFIG.HanulWiki.password||n===NODE_CONFIG.HanulWiki.adminPassword);e===!0&&(i.roles=["USER"]),void 0!==NODE_CONFIG.HanulWiki&&void 0!==NODE_CONFIG.HanulWiki.adminPassword&&n===NODE_CONFIG.HanulWiki.adminPassword&&(i.roles=["USER","ADMIN"]),o(e)})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";var i=HanulWiki.SHARED_STORE("banStore");HanulWiki.ROOM("banRoom",function(n,o,e){o("ban",function(o,e){void 0!==o&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.save({name:o,value:!0,removeAfterSeconds:604800}),e())}),o("noBan",function(o,e){void 0!==o&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.remove(o),e())}),o("getBanList",function(o,e){if(void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0){var t=[];EACH(i.list(),function(i,n){t.push(n)}),e(t)}})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";var i=HanulWiki.SHARED_STORE("banStore");HanulWiki.ROOM("banRoom",function(n,o,e){o("ban",function(o,e){void 0!==o&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.save({name:o,value:!0,removeAfterSeconds:604800}),e())}),o("noBan",function(o,e){void 0!==o&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.remove(o),e())}),o("getBanList",function(o,e){if(void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0){var t=[];EACH(i.list(),function(i,n){t.push(n)}),e(t)}})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";var i=HanulWiki.SHARED_DB("connectionDB");i.save({id:"connectionCountInfo",data:{count:0}}),HanulWiki.ROOM("connectionRoom",function(n,o,e){i.update({id:"connectionCountInfo",data:{$inc:{count:1}}}),HanulWiki.BROADCAST({roomName:"connectionRoom",methodName:"newUser"}),o("__DISCONNECTED",function(){i.update({id:"connectionCountInfo",data:{$inc:{count:-1}}}),HanulWiki.BROADCAST({roomName:"connectionRoom",methodName:"leaveUser"})}),o("getConnectionCount",function(n,o){o(i.get("connectionCountInfo").count)})})}});