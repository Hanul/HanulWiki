HanulWiki.MAIN=METHOD({run:function(){"use strict";var i;1===CPU_CLUSTERING.getWorkerId()&&(i=SHARED_DB("idDB"),INTEGER(86400,RAR(function(){HanulWiki.ArticleModel.find({isFindAll:!0},function(n){var e=[];EACH(n,function(i){var n=0;EACH(e,function(e,o){return e.length<i.id.length?!1:void(n=o+1)}),e.splice(n,0,i.id)}),i.save({id:"ids",data:{ids:e}}),EACH(n,function(i){var n=i.content.trim().replace(/ /g,"").toLowerCase(),o=[];EACH(e,function(e){var t;i.id!==e&&(t=n.replace(new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),""),t.length<n.length&&o.push(e),n=t)}),CHECK_ARE_SAME([i.keywords,o])!==!0&&(HanulWiki.ArticleModel.update({id:i.id,keywords:o}),EACH(o,function(n){HanulWiki.ArticleModel.updateNoHistory({id:n,$addToSet:{backLinks:i.id}})}))})})})))}}),OVERRIDE(HanulWiki.ArticleModel,function(i){"use strict";HanulWiki.ArticleModel=OBJECT({preset:function(){return i},init:function(i,n){var e=SHARED_DB("idDB"),o=HanulWiki.DB("Article__HISTORY"),t=HanulWiki.SHARED_STORE("banStore");i.on("create",{before:function(i,o,a,r){var u,d;return t.get(r.ip)===!0?a({validErrors:{ban:!0}}):(u=i.content.trim().replace(/ /g,"").toLowerCase(),d=e.get("ids").ids,i.keywords=[],i.ip=r.ip,EACH(d,function(n){var e=u.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"");e.length<u.length&&i.keywords.push(n),u=e}),GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(i.id)},function(e){i.id=e,n.get(i.id,{notExists:o,success:function(){a({validErrors:{id:{type:"exists"}}})}})})),!1},after:function(i){var o=e.get("ids").ids,t=0;EACH(o,function(n,e){return n.length<i.id.length?!1:void(t=e+1)}),e.update({id:"ids",data:{$push:{ids:{$each:[i.id],$position:t}}}}),EACH(i.keywords,function(e){n.updateNoHistory({id:e,$addToSet:{backLinks:i.id}})})}}),i.on("update",{before:function(i,n,o,a){var r,u;if(void 0!==a){if(t.get(a.ip)===!0)return o({validErrors:{ban:!0}}),!1;void 0!==i.content&&(r=i.content.trim().replace(/ /g,"").toLowerCase(),u=e.get("ids").ids,i.keywords=[],i.ip=a.ip,EACH(u,function(n){var e;n!==i.id&&(e=r.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),""),e.length<r.length&&i.keywords.push(n),r=e)}))}},after:function(i,e){i.content!==e.content&&(EACH(i.keywords,function(e){n.updateNoHistory({id:e,$addToSet:{backLinks:i.id}})}),HanulWiki.BROADCAST({roomName:"Article",methodName:"recentUpdate",data:i}))}}),i.on("remove",{before:function(i,n,e,o){return t.get(o.ip)===!0||CONFIG.HanulWiki.isCannotRemove===!0&&CHECK_IS_IN({array:o.roles,value:"ADMIN"})!==!0?(e({isNotAuthed:!0}),!1):void 0},after:function(i){e.get("ids").ids;e.update({id:"ids",data:{$pull:{ids:i.id}}}),EACH(i.keywords,function(e){n.updateNoHistory({id:e,$pull:{backLinks:i.id}})})}}),HanulWiki.ROOM(n.getName(),function(i,e){e("view",function(i,e){void 0!==i&&n.updateNoHistory({id:i,$inc:{viewCount:1}},{notExists:e,success:e})}),e("findHistory",function(i,n){void 0!==i&&o.find({filter:{docId:i.id},start:void 0===i.page?0:10*(i.page-1),count:10,sort:{time:-1}},n)}),e("searchIds",function(i,e){void 0!==i&&n.find({filter:{id:{$regex:i.trim().replace(/ /g,"").toLowerCase()}},sort:{viewCount:-1},count:20},function(i){var n=[];EACH(i,function(i){n.push(i.id)}),e(n)})})})}})}),OVERRIDE(HanulWiki.TalkModel,function(i){"use strict";HanulWiki.TalkModel=OBJECT({preset:function(){return i},init:function(i){var n=SHARED_DB("idDB"),e=HanulWiki.SHARED_STORE("banStore");i.on("create",{before:function(i,o,t,a){var r,u;return e.get(a.ip)===!0?(t({validErrors:{ban:!0}}),!1):(r=i.content.trim().replace(/ /g,"").toLowerCase(),u=n.get("ids").ids,i.keywords=[],i.ip=a.ip,EACH(u,function(n){var e=r.replace(new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"");e.length<r.length&&i.keywords.push(n),r=e}),void 0)}})}})}),HanulWiki.AuthRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("authRoom",function(i,n){n("auth",function(n,e){var o=void 0!==CONFIG.HanulWiki&&CONFIG.HanulWiki.isPublic===!0||void 0!==NODE_CONFIG.HanulWiki&&n===NODE_CONFIG.HanulWiki.password;o===!0&&(i.roles=["USER"]),void 0!==NODE_CONFIG.HanulWiki&&void 0!==NODE_CONFIG.HanulWiki.adminPassword&&n===NODE_CONFIG.HanulWiki.adminPassword&&(i.roles=["USER","ADMIN"]),e(o)})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";var i=HanulWiki.SHARED_STORE("banStore");HanulWiki.ROOM("banRoom",function(n,e){e("ban",function(e,o){void 0!==e&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.save({name:e,value:!0,removeAfterSeconds:604800}),o())}),e("noBan",function(e,o){void 0!==e&&void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0&&(i.remove(e),o())}),e("getBanList",function(e,o){if(void 0!==n.roles&&CHECK_IS_IN({array:n.roles,value:"ADMIN"})===!0){var t=[];EACH(i.list(),function(i,n){t.push(n)}),o(t)}})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";var i=HanulWiki.SHARED_DB("connectionDB");i.save({id:"connectionCountInfo",data:{count:0}}),HanulWiki.ROOM("connectionRoom",function(n,e){i.update({id:"connectionCountInfo",data:{$inc:{count:1}}}),HanulWiki.BROADCAST({roomName:"connectionRoom",methodName:"newUser"}),e("__DISCONNECTED",function(){i.update({id:"connectionCountInfo",data:{$inc:{count:-1}}}),HanulWiki.BROADCAST({roomName:"connectionRoom",methodName:"leaveUser"})}),e("getConnectionCount",function(n,e){e(i.get("connectionCountInfo").count)})})}});