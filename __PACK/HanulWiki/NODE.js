HanulWiki.MAIN=METHOD({run:function(){"use strict";1===CPU_CLUSTERING.getWorkerId()&&INTEGER(86400,RAR(function(){var i=SHARED_STORE("idStore");HanulWiki.ArticleModel.find(function(n){var t=[];EACH(n,function(i){var n=0;EACH(t,function(t,e){return t.length<i.id.length?!1:void(n=e+1)}),t.splice(n,0,i.id)}),i.save({name:"ids",value:t})})}))}}),OVERRIDE(HanulWiki.ArticleModel,function(i){"use strict";HanulWiki.ArticleModel=OBJECT({preset:function(){return i},init:function(i,n){var t=SHARED_STORE("idStore"),e=HanulWiki.DB("Article__HISTORY");1===CPU_CLUSTERING.getWorkerId()&&n.find({isFindAll:!0},function(i){var n=[];EACH(i,function(i){var t=0;EACH(n,function(n,e){return n.length<i.id.length?!1:void(t=e+1)}),n.splice(t,0,i.id)}),t.save({name:"ids",value:n})}),i.on("create",{before:function(i,e,o,u){var r=i.content.trim().replace(/ /g,"").toLowerCase(),a=t.get("ids");return i.keywords=[],i.ip=u.ip,EACH(a,function(n){var t=r.replace(new RegExp(n,"g"),"");t.length<r.length&&i.keywords.push(n),r=t}),GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(i.id)},function(t){i.id=t,n.get(i.id,{notExists:e,success:function(){o({validErrors:{id:{type:"exists"}}})}})}),!1},after:function(i){var e=t.get("ids"),o=0;EACH(e,function(n,t){return n.length<i.id.length?!1:void(o=t+1)}),e.splice(o,0,i.id),t.save({name:"ids",value:e}),EACH(i.keywords,function(t){n.updateNoHistory({id:t,$addToSet:{backLinks:i.id}})})}}),i.on("update",{before:function(i,n,e,o){var u,r;void 0!==i.content&&(u=i.content.trim().replace(/ /g,"").toLowerCase(),r=t.get("ids"),i.keywords=[],i.ip=o.ip,EACH(r,function(n){var t;n!==i.id&&(t=u.replace(new RegExp(n,"g"),""),t.length<u.length&&i.keywords.push(n),u=t)}))},after:function(i,t){i.content!==t.content&&EACH(i.keywords,function(t){n.updateNoHistory({id:t,$addToSet:{backLinks:i.id}})})}}),i.on("remove",{after:function(i){var e=t.get("ids");REMOVE({array:e,value:i.id}),t.save({name:"ids",value:e}),EACH(i.keywords,function(t){n.updateNoHistory({id:t,$pull:{backLinks:i.id}})})}}),HanulWiki.ROOM(n.getName(),function(i,t){t("view",function(i,t){void 0!==i&&n.updateNoHistory({id:i,$inc:{viewCount:1}},{notExists:t,success:t})}),t("findHistory",function(i,n){void 0!==i&&e.find({filter:{docId:i},sort:{time:-1}},n)}),t("searchIds",function(i,t){void 0!==i&&n.find({filter:{id:{$regex:i.trim().replace(/ /g,"").toLowerCase()}},sort:{viewCount:-1},count:10},function(i){var n=[];EACH(i,function(i){n.push(i.id)}),t(n)})})})}})}),OVERRIDE(HanulWiki.TalkModel,function(i){"use strict";HanulWiki.TalkModel=OBJECT({preset:function(){return i},init:function(i){i.on("create",{before:function(i,n,t,e){i.ip=e.ip}})}})}),HanulWiki.AuthRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("authRoom",function(i,n){n("auth",function(n,t){var e=void 0!==CONFIG.HanulWiki&&CONFIG.HanulWiki.isPublic===!0||void 0!==NODE_CONFIG.HanulWiki&&n===NODE_CONFIG.HanulWiki.password;e===!0&&(i.roles=["ADMIN"]),t(e)})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("connectionRoom",function(i,n){n("__DISCONNECTED",function(){})})}});