HanulWiki.MAIN=METHOD({run:function(){"use strict";var i;1===CPU_CLUSTERING.getWorkerId()&&(i=SHARED_STORE("idStore"),INTEGER(86400,RAR(function(){HanulWiki.ArticleModel.find({isFindAll:!0},function(n){var e=[];EACH(n,function(i){var n=0;EACH(e,function(e,t){return e.length<i.id.length?!1:void(n=t+1)}),e.splice(n,0,i.id)}),i.save({name:"ids",value:e}),EACH(n,function(i){var n=i.content.trim().replace(/ /g,"").toLowerCase(),t=[];EACH(e,function(i){var e=n.replace(new RegExp(i.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),"");e.length<n.length&&t.push(i),n=e}),CHECK_ARE_SAME([i.keywords,t])!==!0&&(HanulWiki.ArticleModel.update({id:i.id,keywords:t}),EACH(t,function(n){HanulWiki.ArticleModel.updateNoHistory({id:n,$addToSet:{backLinks:i.id}})}))})})})))}}),OVERRIDE(HanulWiki.ArticleModel,function(i){"use strict";HanulWiki.ArticleModel=OBJECT({preset:function(){return i},init:function(i,n){var e=SHARED_STORE("idStore"),t=HanulWiki.DB("Article__HISTORY");i.on("create",{before:function(i,t,o,r){var u=i.content.trim().replace(/ /g,"").toLowerCase(),a=e.get("ids");return i.keywords=[],i.ip=r.ip,EACH(a,function(n){var e=u.replace(new RegExp(n,"g"),"");e.length<u.length&&i.keywords.push(n),u=e}),GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(i.id)},function(e){i.id=e,n.get(i.id,{notExists:t,success:function(){o({validErrors:{id:{type:"exists"}}})}})}),!1},after:function(i){var t=e.get("ids"),o=0;EACH(t,function(n,e){return n.length<i.id.length?!1:void(o=e+1)}),t.splice(o,0,i.id),e.save({name:"ids",value:t}),EACH(i.keywords,function(e){n.updateNoHistory({id:e,$addToSet:{backLinks:i.id}})})}}),i.on("update",{before:function(i,n,t,o){var r,u;void 0!==i.content&&(r=i.content.trim().replace(/ /g,"").toLowerCase(),u=e.get("ids"),i.keywords=[],i.ip=o.ip,EACH(u,function(n){var e;n!==i.id&&(e=r.replace(new RegExp(n,"g"),""),e.length<r.length&&i.keywords.push(n),r=e)}))},after:function(i,e){i.content!==e.content&&EACH(i.keywords,function(e){n.updateNoHistory({id:e,$addToSet:{backLinks:i.id}})})}}),i.on("remove",{after:function(i){var t=e.get("ids");REMOVE({array:t,value:i.id}),e.save({name:"ids",value:t}),EACH(i.keywords,function(e){n.updateNoHistory({id:e,$pull:{backLinks:i.id}})})}}),HanulWiki.ROOM(n.getName(),function(i,e){e("view",function(i,e){void 0!==i&&n.updateNoHistory({id:i,$inc:{viewCount:1}},{notExists:e,success:e})}),e("findHistory",function(i,n){void 0!==i&&t.find({filter:{docId:i},sort:{time:-1}},n)}),e("searchIds",function(i,e){void 0!==i&&n.find({filter:{id:{$regex:i.trim().replace(/ /g,"").toLowerCase()}},sort:{viewCount:-1},count:20},function(i){var n=[];EACH(i,function(i){n.push(i.id)}),e(n)})})})}})}),OVERRIDE(HanulWiki.TalkModel,function(i){"use strict";HanulWiki.TalkModel=OBJECT({preset:function(){return i},init:function(i){i.on("create",{before:function(i,n,e,t){i.ip=t.ip}})}})}),HanulWiki.AuthRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("authRoom",function(i,n){n("auth",function(n,e){var t=void 0!==CONFIG.HanulWiki&&CONFIG.HanulWiki.isPublic===!0||void 0!==NODE_CONFIG.HanulWiki&&n===NODE_CONFIG.HanulWiki.password;t===!0&&(i.roles=["ADMIN"]),e(t)})})}}),HanulWiki.ConnectionRoom=OBJECT({init:function(){"use strict";HanulWiki.ROOM("connectionRoom",function(i,n){n("__DISCONNECTED",function(){})})}});